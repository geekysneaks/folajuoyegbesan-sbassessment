{{ 'pdp-nomad.css' | asset_url | stylesheet_tag }}
{{ 'pdp-nomad.js' | asset_url | script_tag }}

{% liquid
  assign color_option_name = section.settings.color_option_name | default: 'Color'
  assign color_option_index = 0

  for opt in product.options_with_values
    if opt.name == color_option_name
      assign color_option_index = forloop.index
    endif
  endfor
%}
FJJJ
<section class="pdp-nomad" data-section-id="{{ section.id }}">
  <div class="pdp-nomad__grid">
    <!-- Gallery -->
    <div class="pdp-nomad__media" data-product-gallery>
      <div class="pdp-nomad__media-track">
        {% for media in product.media %}
          {% liquid
            assign alt_lc = media.alt | downcase
            assign color_tag = ''
            if alt_lc contains 'color:'
              assign parts = alt_lc | split: 'color:'
              assign color_tag = parts[1] | strip
            endif
          %}
          <div
            class="pdp-nomad__media-item"
            data-media-id="{{ media.id }}"
            data-media-color="{{ color_tag }}"
          >
            {% render 'product-media', media: media %}
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Right column -->
    <div class="pdp-nomad__content">
      <h1 class="pdp-nomad__title">{{ product.title }}</h1>
      <div class="pdp-nomad__price">
        {{ product.selected_or_first_available_variant.price | money }}
      </div>

      <form method="post" action="/cart/add" class="pdp-nomad__form" data-product-form>
        <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" data-variant-id />

       {% for option in product.options_with_values %}
  {% assign is_color = false %}
  {% if option.name == colour_option_name %}
    {% assign is_color = true %}
  {% endif %}

  <div class="pdp-nomad__option" {% if is_color %}data-color-option{% endif %}>
    <div class="pdp-nomad__option-label">{{ option.name }}</div>

    {% if is_color %}
      {% assign swatches = product.metafields.custom.colour_swatches.value %}
      <div class="pdp-nomad__swatches" data-swatches>
        {% for value in option.values %}
          {% assign swatch_hex = '' %}
          {% assign swatch_img = '' %}

          {% if swatches != blank %}
            {% for sw in swatches %}
              {% if sw.name.value == value %}
                {% assign swatch_hex = sw.hex.value %}
                {% assign swatch_img = sw.image.value %}
              {% endif %}
            {% endfor %}
          {% endif %}

          <button
            type="button"
            class="pdp-nomad__swatch"
            data-swatch
            data-option-index="{{ forloop.parentloop.index0 }}"
            data-option-value="{{ value | escape }}"
            aria-label="{{ value }}"
          >
            {% if swatch_img != blank %}
              <span class="pdp-nomad__swatch-img">
                <img
                  src="{{ swatch_img | image_url: width: 80 }}"
                  alt="{{ value }}"
                  loading="lazy"
                >
              </span>
            {% else %}
              <span
                class="pdp-nomad__swatch-hex"
                style="{% if swatch_hex != blank %}background: {{ swatch_hex }};{% else %}background: #ddd;{% endif %}"
              ></span>
            {% endif %}
          </button>
        {% endfor %}
      </div>

      <select name="options[{{ option.name }}]"
              class="pdp-nomad__select"
              data-option-select
              data-option-index="{{ forloop.index0 }}">
        {% for value in option.values %}
          <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
            {{ value }}
          </option>
        {% endfor %}
      </select>

    {% else %}
      <select name="options[{{ option.name }}]"
              class="pdp-nomad__select"
              data-option-select
              data-option-index="{{ forloop.index0 }}">
        {% for value in option.values %}
          <option value="{{ value | escape }}" {% if option.selected_value == value %}selected{% endif %}>
            {{ value }}
          </option>
        {% endfor %}
      </select>
    {% endif %}
  </div>
{% endfor %}

        <button type="submit" class="pdp-nomad__atc" {% unless product.available %}disabled{% endunless %}>
          {% if product.available %}Add to cart{% else %}Sold out{% endif %}
        </button>
      </form>

      <!-- Optional overview bullets (if you create custom.overview_bullets) -->
      {% if product.metafields.custom.overview_bullets.value != blank %}
        <ul class="pdp-nomad__bullets">
          {% for b in product.metafields.custom.overview_bullets.value %}
            <li>{{ b }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      <!-- Raw description stays available for the Details accordion section to parse -->
      <div class="pdp-nomad__description" data-description-html hidden>
        {{ product.description }}
      </div>

      <script type="application/json" data-product-json>
        {{ product | json }}
      </script>
    </div>
  </div>
</section>

{% schema %}
{
  "name": "Main Product (Nomad)",
  "settings": [
    {
      "type": "text",
      "id": "colour_option_name",
      "label": "Colour option name",
      "default": "Colour"
    }
  ]
}
{% endschema %}